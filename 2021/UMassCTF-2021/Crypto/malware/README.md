# malware (434)
> We've identified some ransomeware on one of our employee's systems, but it seems like it was made by a script kiddie. Think you can decrypt the files for us? <br>
> [:arrow_down: Files](malware.zip)

## Solution
AES CTR mode uses the nonce + counter and acts as Stream Cipher-ish.

![img](https://upload.wikimedia.org/wikipedia/commons/thumb/4/4d/CTR_encryption_2.svg/902px-CTR_encryption_2.svg.png)

As Wiki says,

<p align="center"><i>
    "Once an attacker controls the IV–counter pair and plaintext, XOR of the ciphertext with the known plaintext would yield a value that,
    when XORed with the ciphertext of the other block sharing the same IV–counter pair, would decrypt that block."
</i></p>

So the increment of IV in each round and **Repeations of Counter** makes this encryption in this challenge vulnerable.

Now, the order of the file encryptions will tell us which **Keystream Block** was common during encryption of **malware.py** and **flag.txt**.

i.e.

If **malware.py** was encrypted first and **flag.txt** was encrypted just after that then,

KeyStream of malware.py starting from 16th byte will be the same for flag.txt starting from 0th byte because Counter = IV + 1 in each round.

Here is my solution.
```py
#!/usr/bin/env python3

def xor(block1, block2):
	return bytes([a^b for a,b in zip(block1, block2)])

def split_blocks(data, BLOCKSIZE):
	return [data[i:i+BLOCKSIZE] for i in range(0, len(data), BLOCKSIZE)]

BLOCKSIZE = 16
malware_blocks = split_blocks(open('malware.py','rb').read(), BLOCKSIZE)
enc_malware_blocks = split_blocks(open('files/malware.py.enc','rb').read(), BLOCKSIZE)
enc_flag_blocks = split_blocks(open('files/flag.txt.enc','rb').read(), BLOCKSIZE)

flagsize = len(enc_flag_blocks)
files = 4
vals = [i+1 for i in range(files)]

for n in vals:
	final = b''
	for i in range(flagsize):
		keystream = xor(malware_blocks[i+n], enc_malware_blocks[i+n])
		dec_flag = xor(enc_flag_blocks[i], keystream)
		final += dec_flag
	print(f"[n = {n}] = {final}")

```


Solve Script - [[antivirus.py]](antivirus.py)

## Flag
> UMASS{m4lw4re_st1ll_n33ds_g00d_c4ypt0}

## Ref
- https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Counter_(CTR)
